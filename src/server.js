import { ApolloServer, PubSub } from "apollo-server";
import { mergeSchemas } from "graphql-tools";

import schemas from "./schema";
import resolvers from "./resolvers";

export const pubsub = new PubSub();

setInterval(() => {
  pubsub.publish("EVENT", {
    data: {
      id: 123
    }
  })
}, 100)

const schema = mergeSchemas({
  schemas,
  resolvers
});

// GraphQL
export const server = new ApolloServer({
  schema,
  context: async ({ req }) => {
    return ""
  },
  tracing: true,
  subscriptions: {
    onConnect: connectionParams => {
      return new Promise((resolve, reject) => {
        if (connectionParams.secret === 'hello') {
          resolve();
        } else {
          reject({
            message: "no access"
          });
        }
      });
    }
  }
});
